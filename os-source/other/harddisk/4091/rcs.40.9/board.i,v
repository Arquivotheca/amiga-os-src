head     1.11;
branch   ;
access   ;
symbols  ;
locks    ; strict;
comment  @* @;


1.11
date     93.05.06.22.09.18;  author jesup;  state Exp;
branches ;
next     1.10;

1.10
date     92.05.26.23.30.19;  author jesup;  state Exp;
branches ;
next     1.9;

1.9
date     92.03.13.14.36.04;  author jesup;  state Exp;
branches ;
next     1.8;

1.8
date     92.03.12.19.12.31;  author jesup;  state Exp;
branches ;
next     1.7;

1.7
date     92.01.21.14.58.53;  author jesup;  state Exp;
branches ;
next     1.6;

1.6
date     92.01.02.23.40.31;  author jesup;  state Exp;
branches ;
next     1.5;

1.5
date     91.11.26.01.15.58;  author jesup;  state Exp;
branches ;
next     1.4;

1.4
date     91.10.22.16.19.39;  author jesup;  state KS_V37_300;
branches ;
next     1.3;

1.3
date     91.10.13.23.12.14;  author jesup;  state Exp;
branches ;
next     1.2;

1.2
date     91.10.03.11.41.44;  author jesup;  state Exp;
branches ;
next     1.1;

1.1
date     91.06.04.19.35.35;  author jesup;  state Exp;
branches ;
next     ;


desc
@hardware includes
@


1.11
log
@A4091 checkin
added more commands and error codes for scsi
@
text
@**********************************************************************
******************* DEFINITIONS FOR THE DMAC CHIP ********************
**********************************************************************
	IFD	IS_SCSIDISK
DAWR	EQU $03		DACK width register		(byte write only)
WTCH	EQU $04		word transfer count 		(long read/write)
WTCL	EQU $06		actually never used
CNTR	EQU $0b		control register		(byte read/write)
SACH	EQU $0c		DMA address register
SDMA	EQU $13		start DMA			(byte strobe)
FDMA	EQU $17		flush DMA			(strobe)
CINT	EQU $1b		clear interrupts		(strobe)
ISTR	EQU $1f		interrupt status register
SRST	EQU $3f		halt DMA			(strobe)
	ENDC

	IFND	IS_IDE
	IFND	IS_SCSIDISK
ISTR	EQU $41		interrupt status		(read only)
CNTR	EQU $43		control				(read/write)
PBAR	EQU $48		peripheral base address		(read/write)
PDVD	EQU $4c		peripheral device disable	(write only)
WTCH	EQU $80		word transfer count hi		(read/write)
WTCL	EQU $82		word transfer count lo		(read/write)
SACH	EQU $84		source address counter hi	(write only)
SACL	EQU $86		source address counter lo	(write only)
DACH	EQU $88		destination address counter hi	(write only)
DACL	EQU $8a		destination address counter lo	(write only)
DAWR	EQU $8f		data acknowledge width		(read/write)
SDMA   EQU $e0		start DMA			(strobe)
SRST	EQU $e2		software reset (stop DMA)	(strobe)
CINT	EQU $e4		clear interrupts		(strobe)
FDMA   EQU $e8		strobe to flush DMA		(strobe)
	ENDC
	ENDC

; ISTR bits
 BITDEF DMA,ATINT,8	AT port interrupt
 BITDEF DMA,FOLLOW,7	some interrupt pending (even if disabled)
 BITDEF DMA,PINT,6	peripheral interrupt pending (SCSI or XT)
 BITDEF DMA,EOP,5	end of process interrupt (terminal count)
 BITDEF DMA,PEND,4	some interrupt pending (only when enabled)
 BITDEF DMA,UNDER,3	DMA underrun interrupt (never happens, poof)
 BITDEF DMA,OVER,2	DMA overrun interrupt (never happens)
 BITDEF DMA,FIFOF,1	FIFO full  (1=TRUE)
 BITDEF DMA,FIFOE,0	FIFO empty (1=TRUE)

; CNTR bits
	IFD	IS_SCSIDISK
 BITDEF DMA,TCE,5	terminal count enable 		(active high)
 BITDEF DMA,PRESET,4	peripheral reset 		(active high)(strobe)
 BITDEF DMA,PMODE,3	peripheral mode 1=SCSI 0=XT
 BITDEF DMA,INTENA,2	interrupt enable		(active high)
 BITDEF DMA,DDIR,1	data direction 1=write 0=read
 BITDEF DMA,IODX,0	leave low, some random thing
	ENDC

	IFND	IS_IDE
	IFND	IS_SCSIDISK
 BITDEF DMA,TCE,7	terminal count enable 		(active high)
 BITDEF DMA,PRESET,6	peripheral reset 		(active high)(strobe)
 BITDEF DMA,PMODE,5	peripheral mode 1=SCSI 0=XT
 BITDEF DMA,INTENA,4	interrupt enable		(active high)
 BITDEF DMA,DDIR,3	data direction 1=write 0=read
 BITDEF DMA,DMAMD,2	DMA mode 1=memory 0=peripheral
 BITDEF DMA,NASTY,1	same as blitter nasty in mem to mem mode
 BITDEF DMA,XTEOP,0	external EOP enable or XT unit number in XT mode
	ENDC
	ENDC

; various time values for the different drivers
; this is for 250ms (select timeout), (250 * Speed(Mhz))/80
; A3000 is 14.32Mhz (about 70ns), A590/A2091 is 7.16Mhz (about 140ns)
; a2090 = ??????
; for TRANSFER_CYCLE, the calculation is divisor/(2 * freq(in Mhz))
; so, 14Mhz is 105ns, 7Mhz is 140ns.
;
; MIN_SYNC_XFER is the minimum sync transfer time for the WD chip 
; (Tcyc-10 + Tcyc-25).  Absolute minimum is 200ns (assertion + negation +
; 2? cable delays.  However, we can't program it for less than 2*CLOCK_PERIOD
; for send, though we can accept it for input.
;
; LONG_TIMEOUT_VAL is ~300ms (see scsitask for explanation)

	IFD	CLOCK_14MHZ
TIMEOUT_VAL	EQU	44
LONG_TIMEOUT_VAL EQU	52
CLOCK_PERIOD	EQU	105
MIN_SYNC_XFER	EQU	200
	ENDC

	IFD	CLOCK_7MHZ
TIMEOUT_VAL	EQU	23
LONG_TIMEOUT_VAL EQU	27
CLOCK_PERIOD	EQU	140
MIN_SYNC_XFER	EQU	245
	ENDC

; The maximum offset allowed by the WD chip
; WD33C93
MAX_OFFSET		EQU	4
MIN_XFER_PERIOD		EQU	3

; WD33C93A
MAX_OFFSET_A		EQU	12
MIN_XFER_PERIOD_A	EQU	2

	IFD	CLOCK_PERIOD
MIN_MSG_PERIOD		EQU	(((MIN_XFER_PERIOD*CLOCK_PERIOD)+3)/4)
MIN_MSG_PERIOD_A	EQU	(((MIN_XFER_PERIOD_A*CLOCK_PERIOD)+3)/4)
	ENDC


; SCSI commands used by this driver (some may not be used at this time)
TEST_UNIT_READY		EQU $00
REZERO_UNIT		EQU $01
REQUEST_SENSE		EQU $03
FORMAT_UNIT		EQU $04
REASSIGN_BLOCKS		EQU $07
READ			EQU $08
WRITE			EQU $0a
SEEK			EQU $0b
INQUIRY			EQU $12
MODE_SELECT		EQU $15
RESERVE			EQU $16
RELEASE			EQU $17
COPY			EQU $18
MODE_SENSE		EQU $1a
START_STOP_UNIT		EQU $1b
SEND_DIAGNOSTIC		EQU $1d
PREVENT_ALLOW_REMOVAL	EQU $1e
READ_CAPACITY		EQU $25
READ_EXTENDED		EQU $28
WRITE_EXTENDED		EQU $2a
SEEK_EXTENDED		EQU $2b
WRITE_VERIFY		EQU $2e
VERIFY			EQU $2f
PREFETCH		EQU $34
SYNCHRONIZE_CACHE	EQU $35
LOCK_UNLOCK_CACHE	EQU $36
READ_DEFECT_DATA	EQU $37
WRITE_BUFFER		EQU $3b
READ_BUFFER		EQU $3c
MODE_SELECT_10		EQU $55
MODE_SENSE_10		EQU $5a

; Values returned as errors
CHECK_CONDITION		EQU $02
BUSY			EQU $08
RESERVATION_CONFLICT	EQU $18

* sense keys
RECOVERED_ERROR		EQU	$01
MEDIUM_ERROR		EQU	$03
HARDWARE_ERROR		EQU	$04
ILLEGAL_REQUEST		EQU	$05

* sense codes
ILLEGAL_COMMAND		EQU	$20

* messages
ABORT			EQU	$06
ABORT_TAG		EQU	$0d
BUS_DEVICE_RESET	EQU	$0c
CLEAR_QUEUE		EQU	$0e
COMMAND_COMPLETE	EQU	$00
DISCONNECT		EQU	$04
IDENTIFY		EQU	$80
IGNORE_WIDE_RESIDUE	EQU	$23
LINKED_COMMAND_COMPLETE	EQU	$0a
LINKED_CMD_COMPLETE_FLAG EQU	$0b
MESSAGE_PARITY_ERROR	EQU	$09
MESSAGE_REJECT		EQU	$07
MODIFY_DATA_PTR		EQU	$00
NOP			EQU	$08
HEAD_OF_QUEUE_TAG	EQU	$21
ORDERED_QUEUE_TAG	EQU	$22
SIMPLE_QUEUE_TAG	EQU	$20
RESTORE_POINTERS	EQU	$03
SAVE_DATA_POINTERS	EQU	$02
SYNC_REQUEST		EQU	$01
TERMINATE_IO_PROCESS	EQU	$11
EXTENDED_MSG		EQU	$01

; Western Digital SCSI controller chip register addresses (off BoardAddress)
 IFND IS_SCSIDISK
 IFND IS_IDE
 IFND IS_A2090
; A590/A2091
SASR	EQU $91		SCSI auxiliary status register	(read)
;			SCSI register select (write)
SCMD	EQU $93		where all other registers appear (read/write)
 ENDC
 ENDC
 ENDC

 IFD IS_SCSIDISK
; a3000
SASR	EQU $49		SCSI auxiliary status register	(read as a byte)

	IFD	LONGWORD_SASR
SASRW	EQU $48		SCSI register select (write as a longword)
	ENDC

SCMD	EQU $43		where all other registers appear (read/write as a byte)
 ENDC

 IFD A2090
SASR	EQU $61		SCSI auxiliary status register	(read)
;			SCSI register select (write)
SCMD	EQU $63		where all other registers appear (read/write)
 ENDC

; Western Digital SCSI controller chip internal register addresses (absolute)
OWN_ID		EQU	$00		our SCSI buss address (usually 7)
CONTROL		EQU	$01		general DMA and parity controls
TIMEOUT		EQU	$02		timeout period register for select
TOTAL_SECTORS	EQU	$03		used for translate address
TOTAL_HEADS	EQU	$04
TOTAL_CYLS_MSB	EQU	$05
TOTAL_CYLS_LSB	EQU	$06
LOGICAL_ADDR_3	EQU	$07		used for translate address
LOGICAL_ADDR_2	EQU	$08
LOGICAL_ADDR_1	EQU	$09
LOGICAL_ADDR_0	EQU	$0a
SECTOR_NUM	EQU	$0b		used for translate address
HEAD_NUM	EQU	$0c
CYL_NUM_MSB	EQU	$0d
CYL_NUM_LSB	EQU	$0e
TARGET_LUN	EQU	$0f		for identify during select and transfer
COMMAND_PHASE	EQU	$10		select and transfer phase codes
SYNC_TRANSFER	EQU	$11		synchronous transfer timings
TRANSFER_MSB	EQU	$12		transfer length
TRANSFER_MB	EQU	$13
TRANSFER_LSB	EQU	$14
DEST_ID		EQU	$15		SCSI address of target controller
SOURCE_ID	EQU	$16		SCSI address of re-selecting device
SCSI_STATUS	EQU	$17		general status register
COMMAND		EQU	$18		command start register
DATA_REG	EQU	$19		data register for SBT mode

; auxiliary status register bit definitions
 BITDEF WDC,INT,7	an interrupt is pending
 BITDEF WDC,LCI,6	last command ignored
 BITDEF WDC,BSY,5	chip is busy with a level 2 command
 BITDEF WDC,CIP,4	command in progress
 BITDEF WDC,PE,1	a parity error was detected
 BITDEF WDC,DBR,0	data buffer ready during programmed I/O

; control register bit definitions
 BITDEF WDC,DMA,7	DMA mode is enabled for data transfers
 BITDEF WDC,WDB,6	direct buffer access for data transfers
 BITDEF WDC,HA,1	halt on attention (target mode only)
 BITDEF WDC,HPE,0	halt on parity error enable

; source ID register control bits
 BITDEF WDC,ER,7	enable reselection
 BITDEF WDC,ES,6	enable selection (target or multiple initiators only)
 BITDEF WDC,SIV,3	source ID valid

; command register control bits
 BITDEF WDC,SBT,7	enable single byte transfer mode

; own id register bits
 BITDEF WDC,EAF,3	enable advanced features on reset
 BITDEF WDC,EHP,4	enable host parity on bus

; Western digital command codes that are jammed into the command register
wd_RESET		EQU	$00	reset the WDC chip
wd_ABORT		EQU	$01	abort last command
wd_ASSERT_ATN		EQU	$02	we want to send a message
wd_NEGATE_ACK		EQU	$03	we accepted the last message
wd_DISCONNECT		EQU	$04
wd_RESELECT		EQU	$05
wd_SELECT_WITH_ATN	EQU	$06	select with ATN
wd_SELECT		EQU	$07	select without ATN
wd_SELECT_ATN_TRANS	EQU	$08
wd_SELECT_TRANS		EQU	$09
wd_RESEL_AND_RECEIVE	EQU	$0a
wd_RESEL_AND_SEND	EQU	$0b
wd_WAIT_SEL_AND_RECEIVE	EQU	$0c
wd_RECEIVE_COMMAND	EQU	$10
wd_RECEIVE_DATA		EQU	$11
wd_RECEIVE_MSG_OUT	EQU	$12
wd_RECEIVE_INFO_OUT	EQU	$13
wd_SEND_STATUS		EQU	$14
wd_SEND_DATA		EQU	$15
wd_SEND_MSG_IN		EQU	$16
wd_SEND_INFO_IN		EQU	$17
wd_TRANSLATE_ADDRESS	EQU	$18	convert logical offset to head,cyl etc.
wd_TRANSFER_INFO	EQU	$20	do a transfer (MCI says what)
wd_TRANSFER_PAD		EQU	$21	transfer all the same bytes

; Western digital XT controller register addresses for XT unit zero.  Add an
; offset of 20hex to access the second set of XT registers (for XT unit 1)
 IFND REAL_OLD
XTPORT0		EQU	$a1			use byte addressing
XTPORT1		EQU	$a3			switch PORT1 and PORT2...
XTPORT2		EQU	$a5			...for very old boards
XTPORT3		EQU	$a7
 ENDC

 IFD REAL_OLD
XTPORT0		EQU	$a1			use byte addressing
XTPORT2		EQU	$a3			switch PORT1 and PORT2...
XTPORT1		EQU	$a5			...for very old boards
XTPORT3		EQU	$a7
 ENDC

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;
; IDE hardware definitions
;
	IFD	IS_IDE

	IFND IS_A1000
; Slow uses PC/AT timings for compatibility, fast goes at bus speed
IDE_Slow	EQU	$da0000		; not used
IDE_Fast	EQU	$da2000

; address of CDTV-CR int hardware
CDTV_ADDR	EQU	$a40000

; CDTV IDE status bit
	BITDEF	CDTV,IDE,0

; A300/CDTV ide register mapping
; offsets from $da0000.  All regs 8 bit unless noted.
AT_Data		EQU	$00		; 16 bit wide port
AT_Error	EQU	$04		; error register
AT_SectorCnt	EQU	$08		; # of sectors, 0 = 256
AT_SectorNum	EQU	$0c		; sector to start (1-based!)
AT_CylLow	EQU	$10		; low byte of Cylinder number
AT_CylHigh	EQU	$14		; high byte
AT_DriveHead	EQU	$18		; Drive and head number | $A0
AT_Status	EQU	$1c		; (read) status reg, clears interrupt
AT_Command	EQU	$1c		; (write) command value, starts it
AT_AltStatus	EQU	$1018		; (read) alt status, doesn't clear int
AT_DeviceCtrl	EQU	$1018		; (write) device control - int/reset
AT_DriveAddress	EQU	$101c		; not used (pc-ish)
AT_IntStatus	EQU	$1000		; interrupt status bit, active low

; Gayle address and offsets
GAYLE_ADDR	EQU	$da8000
GAYLE_ID_ADDR	EQU	$de1000
GAYLE_VERSION	EQU	%00001101	; version 1101 (first)
GAYLE_IntStatus	EQU	0
GAYLE_IntChange	EQU	$1000
GAYLE_IntEnable	EQU	$2000
GAYLE_Control	EQU	$3000
	ENDC

	IFD IS_A1000
; address of A1000+ jr/sr hardware
IDE_Fast	EQU	$dd2020

; A1000 IDE status bit
	BITDEF	A1000,IDE,15

; offsets are from $dd2000 for A1000+ jr/sr
AT_Data		EQU	$00		; 16 bit wide port
AT_Error	EQU	$06		; error register
AT_SectorCnt	EQU	$0a		; # of sectors, 0 = 256
AT_SectorNum	EQU	$0e		; sector to start (1-based!)
AT_CylLow	EQU	$12		; low byte of Cylinder number
AT_CylHigh	EQU	$16		; high byte
AT_DriveHead	EQU	$1a		; Drive and head number | $A0
AT_Status	EQU	$1e		; (read) status reg, clears interrupt
AT_Command	EQU	$1e		; (write) command value, starts it
AT_AltStatus	EQU	$101a		; (read) alt status, doesn't clear int
AT_DeviceCtrl	EQU	$101a		; (write) device control - int/reset
AT_DriveAddress	EQU	$101e		; not used (pc-ish)
AT_IntStatus	EQU	$1000		; interrupt status bit, active HIGH
					; LONGWORD??, in bit 31!?
AT_ModeReg0	EQU	-$1000		; Mode register 0 (bit 31!?)
AT_ModeReg1	EQU	(-$1000)+2	; Mode register 1 (bit 31!?)
	ENDC

; IDE commands
AT_RECALIBRATE		EQU	$10
AT_READ_SECTORS		EQU	$20
AT_WRITE_SECTORS	EQU	$30
AT_READ_VERIFY_SECTORS	EQU	$40
AT_FORMAT		EQU	$50
AT_SEEK			EQU	$70
AT_DIAGNOSTICS		EQU	$90
AT_INIT_PARAMETERS	EQU	$91	; actually Initialize Drive Parameters
AT_READ_MULTIPLE	EQU	$c4
AT_WRITE_MULTIPLE	EQU	$c5
AT_SET_MULTIPLE_MODE	EQU	$c6
AT_IDENTIFY_DRIVE	EQU	$EC

; Status bits
	BITDEF	AT,ERR,0
	BITDEF	AT,IDX,1
	BITDEF	AT,DRQ,3
	BITDEF	AT,RDY,6
	BITDEF	AT,BSY,7

; Drive/Head bit - set to access drive 1
	BITDEF	DH,SLAVE,4

; enable interrupts bit - device control register
	BITDEF	DC,INT_ENABLE,1

; Error bits
	BITDEF	ERR,AMNF,0
	BITDEF	ERR,TK0NF,1
	BITDEF	ERR,ABRT,2
	BITDEF	ERR,IDNF,4
	BITDEF	ERR,UNC,6
	BITDEF	ERR,BBK,7

; errors I added
	BITDEF	ERR,ADDR,8	; LBA out of range
	BITDEF	ERR,NOT_READY,9	; LUN doesn't respond
	BITDEF	ERR,SELFTEST,10	; self-test failure

	ENDC
@


1.10
log
@removed old define
Made the msg period stuff round up not down!
@
text
@a98 4
	IFD SCSI_SUPPORTED
LONG_SPINUP_DELAY	EQU	(15-1)	; 15 second spinup time for slow drives
	ENDC

d127 1
d131 1
d136 1
d138 3
d144 2
d150 34
@


1.9
log
@Fixed some stuff for A1000 with battmem
@
text
@a101 3
	IFD IS_IDE
LONG_SPINUP_DELAY	EQU	(3-1)	; 3 seconds before we look for BUSY
	ENDC				; (default for a1000 is 1)
d113 2
a114 2
MIN_MSG_PERIOD		EQU	((MIN_XFER_PERIOD*CLOCK_PERIOD)/4)
MIN_MSG_PERIOD_A	EQU	((MIN_XFER_PERIOD_A*CLOCK_PERIOD)/4)
@


1.8
log
@Added new timout values, a1000 defines
@
text
@d99 1
d101 4
@


1.7
log
@Added CDTV HW defs
@
text
@d82 2
d87 1
d94 1
d99 2
d276 1
d278 1
a278 1
IDE_Slow	EQU	$da0000
d281 7
a287 1
; A300/A1000+/A500++ ide register mapping
d311 5
d317 2
a318 2
; address of CDTV-CR hardware
CDTV_ADDR	EQU	$a40000
d320 18
a337 2
; CDTV IDE status bit
	BITDEF	CDTV,IDE,0
@


1.6
log
@The non-A part only handles FIFOs of 4, not 5!!!! the manual lies!!!
Make all variables available all the time (A and non-A).
@
text
@d298 6
@


1.5
log
@additions to handle calculations of various values for the different
versions of the WD chips.
@
text
@a70 11
; The maximum offset allowed by the WD chip
	IFD	WD33C93
MAX_OFFSET	EQU	5
MIN_XFER_PERIOD	EQU	3
	ENDC

	IFD	WD33C93A
MAX_OFFSET	EQU	12
MIN_XFER_PERIOD	EQU	2
	ENDC

d95 15
d217 4
@


1.4
log
@added gayle id defines
@
text
@d70 34
@


1.3
log
@Renamed AT_DigitalOut to AT_DeviceCtrl (match CAM-ATA spec).
Added a define for the INT_ENABLE bit in it.
@
text
@d249 2
@


1.2
log
@IDE mods
@
text
@d243 1
a243 1
AT_DigitalOut	EQU	$1018		; (write) reset/int control
d277 3
@


1.1
log
@Initial revision
@
text
@d4 1
d15 1
d17 19
a35 16
;------
;ISTR	EQU $41		interrupt status		(read only)
;CNTR	EQU $43		control				(read/write)
;PBAR	EQU $48		peripheral base address		(read/write)
;PDVD	EQU $4c		peripheral device disable	(write only)
;WTCH	EQU $80		word transfer count hi		(read/write)
;WTCL	EQU $82		word transfer count lo		(read/write)
;SACH	EQU $84		source address counter hi	(write only)
;SACL	EQU $86		source address counter lo	(write only)
;DACH	EQU $88		destination address counter hi	(write only)
;DACL	EQU $8a		destination address counter lo	(write only)
;DAWR	EQU $8f		data acknowledge width		(read/write)
;SDMA   EQU $e0		start DMA			(strobe)
;SRST	EQU $e2		software reset (stop DMA)	(strobe)
;CINT	EQU $e4		clear interrupts		(strobe)
;FDMA   EQU $e8		strobe to flush DMA		(strobe)
d49 1
d56 1
d58 13
d90 1
d96 4
d101 13
a113 1
 IFD A590
d220 72
@
